# T-banking  
## Описание
Данный проект - это реализация приложения для анализа транзакций, которые находятся в Excel-файле в рамках домашнего задания от *SkyPro*.
  
## Инструкция по установке  
Для того, чтобы проверить код из данного репозитория вам понадобятся **Python**, **Poetry** и **Pycharm**, так что перед началом убедитесь, что они установлены на ваш ПК (проект пишется на версии Python 3.12.7).
Если хотите использовать Python версии ниже, чем 3.12, необходимо отредактировать файл **pyproject.toml**.  
Найдите в нем строчки и вместо **3.12** впишите версию Python, которую хотите использовать:  
```
[tool.poetry.dependencies]  
python = "^3.12"  
```

После чего скачайте все файлы проекта одним архивом:  
```
<> Code -> Download ZIP  
```

Разархивируйте скачанный файл в любое удобное для Вас место.  
Откройте папку проекта **widget_for_bank** с помощью **PyCharm**. 

Для работы приложения пропишите в терминале
~~~
poetry install
~~~
## Инструкция по использованию
В пакете **src** содержится 6 модулей: **main**, **views**, **external_api**, **reports**, **services** и **utils**:

1. *main.py*
В данном модуле собран макет для демонстрации реализованных вспомогательных функций из других модулей.

Необходимые константы для запуска проекта:
~~~
DATE_TO_TEST = '2021-11-13 10:00:00'  
PATH_TO_EXCEL = os.path.join(DATA_DIR, "operations.xlsx")  
TRANSACTIONS = get_data_frame_from_excel_file(PATH_TO_EXCEL)  
TRANSACTIONS_DICT = TRANSACTIONS.to_dict(orient='records')
~~~
### Веб-страница  «Главная»
~~~
print(get_main_page(DATE_TO_TEST, TRANSACTIONS))  
~~~
Принимает на вход строку с датой и временем в формате YYYY-MM-DD HH:MM:SS и возвращает JSON-ответ со следующими данными:

1. **Приветствие** в формате **"???"**, где **???** — «Доброе утро» / «Добрый день» / «Добрый вечер» / «Доброй ночи» в зависимости от текущего времени.
2. **По каждой карте:**
- последние 4 цифры карты;
- общая сумма расходов;
- кэшбэк (1 рубль на каждые 100 рублей).
1. **Топ-5 транзакций по сумме платежа.**
2. **Курс валют.**
3. **Стоимость акций из S&P500.**
~~~
Пример структуры JSON-ответа:

{
  "greeting": "Добрый день",
  "cards": [
    {
      "last_digits": "5814",
      "total_spent": 1262.00,
      "cashback": 12.62
    },
    {
      "last_digits": "7512",
      "total_spent": 7.94,
      "cashback": 0.08
    }
  ],
  "top_transactions": [
    {
      "date": "21.12.2021",
      "amount": 1198.23,
      "category": "Переводы",
      "description": "Перевод Кредитная карта. ТП 10.2 RUR"
    },
    {
      "date": "20.12.2021",
      "amount": 829.00,
      "category": "Супермаркеты",
      "description": "Лента"
    },
    {
      "date": "20.12.2021",
      "amount": 421.00,
      "category": "Различные товары",
      "description": "Ozon.ru"
    },
    {
      "date": "16.12.2021",
      "amount": -14216.42,
      "category": "ЖКХ",
      "description": "ЖКУ Квартира"
    },
    {
      "date": "16.12.2021",
      "amount": 453.00,
      "category": "Бонусы",
      "description": "Кешбэк за обычные покупки"
    }
  ],
  "currency_rates": [
    {
      "currency": "USD",
      "rate": 73.21
    },
    {
      "currency": "EUR",
      "rate": 87.08
    }
  ],
  "stock_prices": [
    {
      "stock": "AAPL",
      "price": 150.12
    },
    {
      "stock": "AMZN",
      "price": 3173.18
    },
    {
      "stock": "GOOGL",
      "price": 2742.39
    },
    {
      "stock": "MSFT",
      "price": 296.71
    },
    {
      "stock": "TSLA",
      "price": 1007.08
    }
  ]
}
~~~

### Сервис "Выгодные категории повышенного кэшбэка"
~~~ 
print(get_cashback_categories(TRANSACTIONS_DICT, 2021, 11))  
~~~

Сервис позволяет проанализировать, какие категории были наиболее выгодными для выбора в качестве категорий повышенного кэшбэка.

На вход функции поступают данные для анализа, год и месяц.

**Входные параметры:**
*data* — данные с транзакциями;
*year* — год, за который проводится анализ;
*month* — месяц, за который проводится анализ.

На выходе — JSON с анализом, сколько на каждой категории можно заработать кэшбэка в указанном месяце года.

**Выходные параметры:**
JSON с анализом, сколько на каждой категории можно заработать кэшбэка.
~~~
Формат выходных данных:

{
  "Аптеки": 175.0,
  "Супермаркеты": 570.0,
  "Местный транспорт": 14.0,
  "Косметика": 27.0,
  "Дом и ремонт": 52.0,
  "Сувениры": 2.0,
  "Развлечения": 3.0,
  "Одежда и обувь": 4.0,
  "Сервис": 3.0,
  "Фастфуд": 1.0
}
~~~

### Отчет "Траты по категории" 
~~~
print(spending_by_category(TRANSACTIONS, 'Супермаркеты', DATE_TO_TEST))
~~~

Для данной функции написан декоратор **get_report_func_result** из модуля **views**, который записывает в файл результат, который возвращает функция, формирующая отчет.

- **Декоратор без параметра** — записывает данные отчета в файл с названием по умолчанию (формат имени файла придумайте самостоятельно).
- **Декоратор с параметром** — принимает имя файла в качестве параметра.

**Функция принимает на вход:**
- датафрейм с транзакциями,
- название категории,
- опциональную дату.

Если дата не передана, то берется текущая дата.

Функция возвращает траты по заданной категории за последние три месяца (от переданной даты).

2.  *views.py*
В данном модуле реализованы основные функции для генерации JSON-ответов
```
def get_main_page(date: str, transactions: pd.DataFrame) -> str:
    """
    Принимает дату в виде строки формата YYYY-MM-DD HH:MM:SS
    и транзакции в виде DataFrame, возвращает JSON-ответ с информацией
    greeting, cards, top_transactions, currency_rates и stock_prices
    """
```

```
def get_cashback_categories(transactions: list[dict], year: int, month: int) -> str:
    """
    На вход поступают транзакции в виде списка словарей,
    год и месяц в формате целых чисел, на выходе словарь с категориями и кэшбэком по ним
    """
```

~~~
def get_report_func_result(report_name: str = 'func_result_report.json') -> (
        Callable)[[Callable[P, pd.DataFrame]], Callable[P, pd.DataFrame]]:
    """
    Декоратор вывода результата функции
    """
~~~

3.  *external_api.py*
В данном модуле реализованы функции обращения к внешним API.
```
def get_currency_rate(currency: str) -> Union[float, str]:
    """ Принимает валюту в виде строки и возвращает курс в рублях """
```

```
def get_stock_price(stock: str) -> Union[float, str]:
    """ Принимает тикер акции в виде строки, возвращает ее стоимость в USD """
```

4.  *reports.py*
В данном модуле реализована функция отчета трат по категориям, которая обернута декоратором  **get_report_func_result** из модуля **views**. Данные записываются в файл (по умолчанию **./json/func_result_report.json**)
```
@get_report_func_result()
def spending_by_category(transactions: pd.DataFrame,
                         category: str,
                         date: Optional[str] = None) -> pd.DataFrame:
    """
    Принимает транзакции в виде DataFrame, категорию в виде строки и дату
    в виде строки в формате YYYY-MM-DD HH:MM:SS
    Возвращает DataFrame транзакций по категории за последние три месяца от переданной даты
    """
```

5.  *services.py*
В данном модуле реализована функция.
```
def get_cashback_categories_dict(transactions: list[dict], year: int, month: int) -> dict:
    """
    На вход поступают транзакции в виде списка словарей,
    год и месяц в формате целых чисел, на выходе словарь с категориями и кэшбэком по ним
    """
```

1.  *utils.py*
В данном модуле реализованы функции.
~~~
def get_greeting() -> str:
    """ Возвращает строку с приветствием """
~~~

~~~
def get_data_frame_from_excel_file(path_to_excel_file: str) -> pd.DataFrame:
    """ Принимает путь до xlsx-файла, возвращает DataFrame """
~~~

~~~
def get_cards(transactions: pd.DataFrame) -> list[dict]:
    """
    Принимает DataFrame с транзакциями, возвращает список словарей
    last_digits, total_spent и cashback
    """
~~~

~~~
def get_top_transactions(transactions: pd.DataFrame) -> list[dict]:
    """
    Принимает DataFrame с транзакциями, возвращает список словарей
    date, amount, category и description
    """
~~~

~~~
def get_currency_rates(path_to_user_settings_json: str) -> list[dict]:
    """ Принимает путь до пользовательских настроек в формате json,
     возвращает список словарей currency и rate """
~~~

~~~
def get_stock_prices(path_to_user_settings_json: str) -> list[dict]:  
    """ Принимает путь до пользовательских настроек, возвращает стоимость акций в виде списка словарей """
~~~
## Тестирование проекта
Тестирование осуществляется при помощи фреймворка pytest, а также определяется процент покрытия кода с помощью pytest-cov.

Для установки, если используете poetry, пропишите в терминале:
```
poetry add --group dev pytest pytest-cov
```

Если пользуетесь стандартным виртуальным окружением, для установки пропишите:
```
pip install pytest pytest-cov
```

Для запуска тестов, которые написаны в папке tests, пропишите в терминале:
```
pytest
```

Для проверки процента покрытия кода и генерации результатов в отдельный html файл пропишите в терминале следующее:
```
pytest --cov=src --cov-report=html
```
